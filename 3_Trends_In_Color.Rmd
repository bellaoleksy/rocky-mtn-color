---
title: "LimnoSat-US_Tutorial"
author: "Simon Topp"
date: "11/2/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---




```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(sf)
library(feather)
library(lubridate)
library(mapview)
library(USAboundaries)
library(s2)
library(elevatr)
library(trend)
library(tsibble)
library(imputeTS)
library(ggthemes)
library(nhdplusTools)
library(tmap)
library(raster)
library(caret)
library(rpart)
library(yardstick)
library(rpart.plot)
library(patchwork)
library(cowplot)


sf_use_s2(use_s2 = T)
knitr::opts_chunk$set(echo = TRUE, warning = F, comment = F, message = F)
```


## Trend Analysis

### Trend Data prep

Lots of key decisions in here. Could iterate


```{r, eval = F}



co_summary <- ls_co %>%
  dplyr::select(-year, -sat) %>%
  mutate(month = month(date),
         year = year(date),
         doy = yday(date)) %>%
  filter(month %in% 7:9, 
         doy <= 258) %>% #Sept 14/15
  group_by(Hylak_id,year) %>%
  add_count() %>%
  filter(year >= 1984) %>% #changed to >= so we don't drop 1984... 
  filter(n >= 3) %>% # at least 3 observations per year
  group_by(Hylak_id) %>%
  mutate(unique_years = n_distinct(year)) %>%
  filter(unique_years > 30) %>% # at least 30 years of data
  arrange(year) %>%
  #complete years
  group_by(Hylak_id,year) %>%
  summarize(across(c(Blue:dWL),
                   .fns = list(mean = mean,
                               sd = sd,
                               max = max,
                               min = min,
                               median = median), na.rm = T,
                   .names = "{.col}-{.fn}"))%>%
  ungroup() %>%
  as_tsibble(., key = Hylak_id, index=year) %>% #time series tibble
  fill_gaps() %>% #imputing, though not sure what's going on under the hood
  as_tibble() %>%
  pivot_longer(cols = `Blue-mean`:`dWL-median`,
               names_to = c('var','stat'),
               names_sep = '-') %>%
  group_by(Hylak_id, var, stat) %>%
  arrange(year) %>%
  mutate(impute_value = na_interpolation(value, maxgap = 1))


filled_enough <- co_summary %>%
  group_by(Hylak_id) %>%
  summarize(any_nas = any(is.na(impute_value))) %>% # check if there are missing values in each Hylak_id timeseries
  filter(any_nas == F) # only select the sites with a max of 1 year of missing data


co_full <- co_summary %>%
  filter(Hylak_id %in% filled_enough$Hylak_id) 

#How many lakes? 
length(unique(co_full$Hylak_id))

save(co_full, file = 'data/color_summary.RData')
```





## Net Trends in DWL


```{r}

load('data/ls_elev.RData')
load('data/color_summary.RData')
load('data/nhd_lakes.RData')
load('data/glcp_sub.RData')

nhd_hylak <- nhd_hylak %>%
  filter(elevation >= 1400) %>% ## changed to have the same cut off as in 2_GreenBlueMedians.Rmd? 
  filter(ftype %in% c('LakePond','Reservoir')) 

actually_high_lakes <- nhd_hylak


high_lakes <- co_full %>%
  filter(Hylak_id %in% actually_high_lakes$Hylak_id)

#How many lakes? 
length(unique(high_lakes$Hylak_id))


map_sens <- function(df){
  sens.slope(df$impute_value)
}




sens_est <- function(mod){
  mod$estimate
}

val_mean <- function(df){
  early_mean <- df %>%
    filter(year < 2005) %>%
    pull(impute_value) %>%
    mean(., na.rm = T)
}

trend_plotter <- function(study_lakes = high_lakes,
                          v = 'dWL',
                          x = 'Dominant Wavelength Sens Slope'){
  
  
  trend_plot <- function(df){
    ggplot(df,aes(x = year,
                  y = impute_value)) +
      geom_point() + 
      stat_smooth(method = 'lm')
  }
  
  
  co_mods <- study_lakes %>%
    filter(var == v) %>%
    group_by(Hylak_id, stat) %>%
    nest() %>%
    mutate(sens = map(data, map_sens),
           plots = map(data, trend_plot),
           sens_sum = map(sens,broom::glance),
           slope = map(sens,sens_est),
           early_mean = map(data, val_mean))
  
  
  sens_sum = unnest(co_mods, c(sens_sum,slope, early_mean)) %>%
    mutate(Trend = case_when(p.value <= 0.05 & slope >= 0 & early_mean < 530 ~ 'Blue -> Green',
                             p.value <= 0.05 & slope >= 0 & early_mean > 530 ~ 'Intensifying Green',
                             p.value <= 0.05 & slope <= 0 & early_mean > 530 ~ 'Green -> Blue',
                             p.value <= 0.05 & slope <= 0 & early_mean < 530 ~ 'Intensifying Blue',
                             p.value > 0.05 ~ 'No trend'),
           Trend = factor(Trend, 
                          levels = c('No trend',
                                      'Intensifying Blue',
                                     'Green -> Blue',
                                     'Intensifying Green',
                                     'Blue -> Green')))
  

  plot <- ggplot(sens_sum %>%
                  dplyr::filter(stat != 'sd'),aes(x=slope,color=Trend)) + 
    geom_freqpoly(bins = 20, size = 1) + 
    facet_wrap(~stat) +
    theme_few() + 
    theme(legend.position = 'top',
          legend.direction = 'horizontal') +
    guides(color=guide_legend(nrow=2, byrow=TRUE)) + 
    scale_color_manual(values = c('gray20','#1f78b4','#a6cee3','#b2df8a','#33a02c'),
                       name = '') + 
    xlab(x) + 
    ylab('Lake count')
  
  
  return(list(sens_sum, plot))
}





```

## DWL modes

### DWL histogram


```{r}
high_lakes_descriptor <- glcp_high_lakes %>%
  group_by(Hylak_id) %>%
  summarize(across(where(is.numeric),mean))



high_modes <- high_lakes %>%
  filter(var == 'dWL',
         stat == 'median') %>%
  dplyr::mutate(decade = cut(year, breaks = c(1984,1996,2008,2021),
                             labels = c('1985-96','1997-2008','2009-2020'))) %>%
  group_by(Hylak_id, decade) %>%
  summarize(dWL = round(median(value, na.rm = T),0)) %>%
  ungroup() %>%
  inner_join(fui.lookup) %>%
  inner_join(fui.colors) 


bg.fui = tibble(
  ymin = c(470,475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583),
  ymax = c(475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583,590),
  color = c(
  "#2158bc", "#316dc5", "#327cbb", "#4b80a0", "#568f96", "#6d9298", "#698c86", 
  "#759e72", "#7ba654", "#7dae38", "#94b660","#94b660", "#a5bc76", "#aab86d", 
  "#adb55f", "#a8a965", "#ae9f5c", "#b3a053", "#af8a44", "#a46905", "#9f4d04")
)

##Legend only
legend<-ggplot() + 
  geom_rect(data = bg.fui, 
            aes(ymin = ymin, ymax = ymax, xmin = -5, xmax = 100, fill = color)) + 
  scale_fill_identity() + 
  theme_few() +
  scale_x_continuous(expand = c(0, 0))+
  scale_y_continuous(expand = c(0, 0))+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=5),
        axis.title.y=element_text(size=6),
        plot.title=element_text(size=6, hjust=-0.05))+
  labs(y="Dominant wavelength (nm)",
       title="Forel-Ule\ncolor")

# make prettier
# png(filename = 'figs/dwl_hist_three_periods.png', width = 4, height = 4,
#     units = 'in', res = 300)
# 
# 
# base<-ggplot() + 
#   facet_wrap(~decade, ncol = 1) + 
#   geom_rect(data = bg.fui, 
#             aes(xmin = ymin, xmax = ymax, ymin = -5, ymax = 100, fill = color)) + 
#   geom_vline(xintercept = 530, linetype = 3) +
#   geom_histogram(data = high_modes, aes(x=dWL, y = ..density..), fill = NA,
#                  color = 'black', alpha = .3, bins = 40) + 
#   geom_density(data = high_modes, aes(x=dWL)) + 
#   scale_x_continuous(expand = c(0, 0))+ #get rid of whitespace
#   scale_fill_identity() + 
#   theme_few() +
#   coord_cartesian(ylim = c(0,.03))  +
#   labs(x="Dominant wavelength (nm)",
#        y="Density")
# 
# base+inset_element(legend, 0.85, 0.75, 1, 1)
# 
# layout <- '
# A#
# AB
# A#
# '
# wrap_plots(A = base, B = legend, design = layout)+
#   plot_layout(widths = c(5, 0.5))
# 
# 
# dev.off()





```


## DWL Trends

```{r}
# dWL_trends <- trend_plotter()

##IAO-- this is cool but I think we will want to only look at median.
#Or if we want to look at max, maybe filter down to only sites with >3 observations a year?

# png(filename = 'figs/dwl_hist.png', width = 4,
#     height = , units = 'in', res = 300)
# dWL_trends[[2]]
# dev.off()

## Pull data for plotting

dwl <- dWL_trends[[1]] %>%
  inner_join(nhd_hylak, by = 'Hylak_id')

dwl_all <- dwl %>%
  filter(stat == 'median') %>%
  unnest(data)


# set.seed(111)
set.seed(1)
dwl_specials <- dwl_all %>%
  # filter(abs(slope) >= 1 | Trend == 'No trend') %>%
  # filter(p.value < 0.05 | Trend == 'No trend') %>% # Had to change from 0.001 to 0.05 to get a blue->green example lake
  filter(abs(slope) >= 1 & p.value < 0.05) %>% #I think it would be better to not show a trend line for "No Trend"
  group_by(Trend) %>%
  sample_n(1) %>%
  pull(Hylak_id) 

full_spec <- dwl_all %>%
  filter(Hylak_id %in% dwl_specials)

#How many lakes in each trend category?
trend_labels<-dwl_all %>%
  group_by(Trend) %>%
  summarize(n=length(unique(Hylak_id))) %>%
  mutate(perc=(n/sum(n))*100,
         perc=round(perc,0)) 

#Export
png(filename = 'figs/Trend Examples 2.png',
    width = 5,
    height = 8,
    res = 600,
    units = 'in')
ggplot(dwl_all, aes(x = year, y = value, fill=Trend, colr=Trend, group = Hylak_id)) +
  geom_smooth(method = 'lm',
              se = FALSE,
              col = 'grey50',
              alpha=0.5,
              size=0.1) + 
  geom_point(data = full_spec, shape=21) + 
  geom_smooth(data = full_spec, aes(color=Trend),
              # color = 'black',
              method = 'lm',
              se = FALSE) + 
  scale_fill_manual(values = c('gray20','#a6cee3','#1f78b4','#33a02c','#b2df8a'),
                       name = '') + 
  scale_color_manual(values = c('#a6cee3','#1f78b4','#33a02c','#b2df8a'),
                       name = '') + 
  geom_text(x = 1990, y = 585,
            aes(group=Trend, label = paste("n =",n)),
            data = trend_labels, size=3)+ #Add label for sample size
  scale_x_continuous(breaks=seq(1986, 2018, 6))+
  facet_wrap(~Trend, nrow=5) + 
  theme_few()+
  theme(legend.position="none",
        plot.margin = unit(c(0,0.2,0,0), "cm"),)+
  labs(y="Dominant wavelength (nm)",
       x="Year") +

ggplot(dwl_all,aes(x=slope,color=Trend)) + 
  geom_freqpoly(bins = 20, size = 1) + 
  geom_vline(xintercept=0, linetype="dashed", size=0.5)+
  facet_wrap(~Trend, nrow=5, scales="free_y") +
  theme_few() + 
  scale_y_continuous(position="right")+
  scale_x_continuous(breaks=seq(-1.5, 1.5, 1))+
  theme(legend.position="none",
        plot.margin = unit(c(0,0,0,0.2), "cm"),
      # legend.position = 'top',
          legend.direction = 'horizontal') +
    # guides(color=guide_legend(nrow=2, byrow=TRUE)) + 
  scale_color_manual(values =  c('gray20','#a6cee3','#1f78b4','#33a02c','#b2df8a'),
                       name = '') + 
  xlab("Slope")+
  ylab('Lake count')
dev.off()

```

#### Get lat/long for PRISM
```{r}
#Extract lat/long for PRISM
dwl_all_ungrouped<-dwl_all%>%ungroup()%>%select(Hylak_id, geometry) 

separated_coord <- dwl_all_ungrouped %>%
    mutate(lat = unlist(map(dwl_all_ungrouped$geometry,2)),
           long = unlist(map(dwl_all_ungrouped$geometry,1))) %>%
  select(-geometry) %>%
  distinct() %>%
  relocate(Hylak_id, .after = last_col())

#PRISM can only pull 500 sites at a time, so split into two dataframes
separated_coord_1<-separated_coord %>%
  slice(1:500)
separated_coord_2<-separated_coord %>%
  slice(501:nrow(.))
# write_csv(separated_coord_1, "data/prism/separated_coord_1.csv", col_names = FALSE)
# write_csv(separated_coord_2, "data/prism/separated_coord_2.csv",col_names = FALSE)
# Use the above .csv files to download PRISM data for each individual lakes
# https://prism.oregonstate.edu/explorer/bulk.php 

#Read in PRISM data
dir<-here("data/prism/download")
files<-list.files(dir)
prism<-data.frame() # data frame to store all prism data
for(i in 1:length(files)){ # loops over all files in prism/download directory
  cur<-read.table(file.path(dir,paste(files[i],sep='')),
                  header=T,sep=",",skip=10,
                  stringsAsFactors = F) # read in all prism files
  cur$fileName<-files[i]
  #keep track of which .csv file data came from to make sure it's all there
  prism<-rbind(prism,cur)
}
prism<-prism %>%
    rename(ppt_mm=`ppt..mm.`,
           tmean_degC=`tmean..degrees.C.`,
           elev_m_prism=`Elevation..m.`,
           Hylak_id=Name,
           lon_dec_deg=Longitude,
           lat_dec_deg=Latitude,
           date=Date)%>%
  mutate(date=ym(date)) 
  # select(-fileName)
length(unique(prism$fileName))

str(prism)
#Double check to make sure all data are there

```


## DWL map

```{r}

class(definitely_lakes)
dwl_map <- dwl %>%
  filter(stat == 'median',
         Hylak_id %in% nhd_hylak_blue_mod$Hylak_id) %>%
  dplyr::select(Hylak_id,Trend) %>%
  inner_join(site_cols,.) %>%
  arrange(Trend)



png(filename = 'figs/trend_map.png',
    width = 4, height = 6, units = 'in', res = 300)

tm_shape(hil) +
  tm_raster(palette = gray(0:10 / 10), style = "cont", legend.show = FALSE) + 
tm_shape(ras) + 
  tm_raster(alpha = 0.4,
            style = 'cont',
            title = 'Elevation (m)',
            palette = 'Greys',
            legend.show = F) + 
  tm_shape(dwl_map) + 
  tm_dots(title = '',size = .2,
             col = 'Trend',
          shape = 16,
          palette = c('gray20','#1f78b4','#a6cee3','#b2df8a','#33a02c')) + 
  tm_legend(legend.position = c(0.1,0.08))

dev.off()


```


## DWL Trends -- why?