---
title: "2009-2020 lake colors and controls"
author: "Matthew Ross"
date: "01/12/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---






```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(sf)
library(feather)
library(lubridate)
library(mapview)
library(USAboundaries)
library(s2)
library(elevatr)
library(trend)
library(tsibble)
library(imputeTS)
library(ggthemes)
library(nhdplusTools)
library(tmap)
library(raster)
library(caret)
library(rpart)
library(yardstick)
library(rpart.plot)
library(here)
library(data.table)
library(cvms)

# Use dplyr select
select<-dplyr::select

sf_use_s2(use_s2 = T)
knitr::opts_chunk$set(echo = TRUE, warning = F, comment = F, message = F)

```


# Where blue green lakes are

## Pull in data
```{r}
load("data/glcp_sub.RData")
load("data/color_summary.RData")
load("data/lake_descriptor.RData")
load("data/ls_elev.RData")
# load("data/nhd_lakes.RData")


```


### Super join to all things w/ Median DWL 2009-2020

```{r}

#Grab modern decade median color
co_summary_median <- ls_co %>%
  dplyr::select(-year, -sat) %>%
  mutate(month = month(date),
         year = year(date),
         doy = yday(date)) %>%
  filter(month %in% 7:9, 
         doy <= 258, #Sept 14/15
         year >= 2009,
         elevation > 1400) %>% 
  group_by(Hylak_id) %>%
  add_count() %>%
  filter(n >= 30) %>%
  group_by(Hylak_id) %>%
  summarize(across(c(Blue:dWL),
                   .fns = list(mean = mean, 
                               sd = sd, 
                               max = max,
                               min = min,
                               median = median), na.rm = T,
                   .names = "{.col}-{.fn}"))%>% 
  ungroup() %>%
  pivot_longer(cols = `Blue-mean`:`dWL-median`,
               names_to = c('var','stat'),
               names_sep = '-')

#Grab just median dWL for each lake
dwl_medians <- co_summary_median %>%
  filter(var == 'dWL',
         stat == 'median') %>%
  select(-var,-stat) %>%
  rename(dWL = value)


#From recent decade to match map
blue_green_2018 <- glcp_high_lakes %>%
  filter(year >= 2009) %>%
  inner_join(dwl_medians) %>%
  group_by(Hylak_id) %>%
  summarize(across(where(is.numeric),median, na.rm = T)) %>%
  mutate(group = cut(dWL, 
                     breaks = c(0,530,Inf), 
                     labels = c('Blue/clear',
                                          'Green/murky'))) %>%
  dplyr::filter(!is.na(dWL)) %>%
  inner_join(lake_descriptor) %>%
  mutate(air_temp = mean_annual_temp_k - 273.15,
         PctUrb2016Ws = PctUrbLo2016Ws + PctUrbMd2016Ws + PctUrbHi2016Ws,
         PctWet2016Ws = PctWdWet2016Ws + PctHbWet2016Ws) %>%
  # LakeCAT and GLCP predictors, maybe add in land use when fixed
  dplyr::select(precip = mean_monthly_precip_mm,
                air_temp,
                res = lake_rsvr_class,
                lake_connectivity = lake_connectivity_class,
                area = areasqkm, # different from ws_area below???
                elev = elevation,
                meandepth,
                pop_sum,
                maxdepth,
                ws_area = WsAreaSqKm,
                no3_dep = NO3_2018Ws,
                nh3_dep = NH4_2018Ws,
                carb = PctCarbResidWs,
                sil = PctSilicicWs, 
                LSA = lake_waterarea_ha, #lake surface area [ha]
                perc_open_water = PctOw2016Ws, #% open water 2016
                perc_ice = PctIce2016Ws,#% of catchment area classified as ice/snow land cover
                perc_urban = PctUrb2016Ws, #% of catchment area classified as developed, low+med+high-intensity land use
                perc_decid = PctDecid2016Ws, #% of catchment area classified as deciduous forest land cover
                perc_conifer = PctConif2016Ws, #% of catchment area classified as evergreen forest land cover 
                perc_mixedForest = PctMxFst2016Ws,#% of catchment area classified as mixed deciduous/evergreen forest land cover
                perc_shrub = PctShrb2016Ws, #% of catchment area classified as shrub/scrub land cover 
                perc_grass = PctGrs2016Ws, #% of watershed area classified as grassland/herbaceous land cover 
                perc_hay = PctHay2016Ws, #% of watershed area classified as hay land use
                perc_crop = PctCrop2016Ws, #% of watershed area classified as crop land use
                perc_wetland = PctWet2016Ws, #% of watershed area classified as herbaceous+woody wetland land cover
                slope = SlopeWs, #Mean watershed slope, **I THINK**
                cti = WetIndexWs, #Mean Composite Topographic Index (CTI)
                dWL,
                Hylak_id,
                group) %>%
  mutate(WALA=area/LSA) %>% #drainage ratio, watershea area:lake area)
  na.omit(.) #Everything has to be complete data. 

  
#How many sites do we drop with na.omit()
# length(unique(blue_green_2018$Hylak_id))
#1318
# blue_green_2018 <- blue_green_2018 %>% na.omit(.)
# length(unique(blue_green_2018$Hylak_id))
#956




```


## Figures


### Site Map w/ Forel-Ule Color

```{r}


site_cols <- blue_green_2018 %>%
  mutate(dWL = round(dWL,0)) %>%
  inner_join(fui.lookup) %>%
  inner_join(fui.colors) %>%
  inner_join(lake_descriptor %>%
               dplyr::select(Hylak_id),.)




buffer_box <- st_bbox(site_cols) %>%
  st_as_sfc(.) %>%
  st_buffer(50000) %>%
  st_bbox()



ras <- get_elev_raster(site_cols, z = 5) %>%
  raster::crop(.,buffer_box)

ras[ras < 0] <- 0
slope <- terrain(ras, 'slope')
aspect <- terrain(ras, 'aspect')

hil <- hillShade(slope, aspect)

states <- USAboundaries::us_states()


png(filename = 'figs/bg_better_map.png',
    width = 4, height = 6, units = 'in', res = 300)

tm_shape(hil) +
  tm_raster(palette = gray(0:10 / 10),
            style = "cont", legend.show = FALSE) + 
tm_shape(ras) + 
  tm_raster(alpha = 0.4,
            style = 'cont',
            title = 'Elevation (m)',
            palette = 'Greys') + 
tm_shape(states) + 
  tm_borders(lwd = 1,
             col = 'black') + 
  tm_shape(site_cols) + 
  tm_bubbles(size = .2,
             col = 'color',
             border.col = 'black',
             border.lwd = 1,
             jitter = .3) + 
  tm_legend(legend.position = c(0,0),
            legend.bg.color = 'gray90',
            legend.frame = 'black') 

dev.off()


```


### Blue Green Category Only Map

```{r}



png(filename = 'figs/bg_map.png',
    width = 5, height = 8, units = 'in', res = 300)

tm_shape(hil) +
  tm_raster(palette = gray(0:10 / 10),
            style = "cont", legend.show = FALSE) + 
tm_shape(ras) + 
  tm_raster(alpha = 0.4,
            style = 'cont',
            title = 'Elevation (m)',
            palette = 'Greys') + 
tm_shape(states) + 
  tm_borders(lwd = 1,
             col = 'black') + 
  tm_shape(site_cols) + 
  tm_bubbles(size = .2,
             col = 'group',
             border.col = 'black',
             border.lwd = 1,
             jitter = .3,
             palette = c('deepskyblue2','darkolivegreen3')) + 
  tm_legend(legend.position = c(0,0),
            legend.bg.color = 'gray90',
            legend.frame = 'black') 

dev.off()



```

### Interactive BG map

```{r, eval = F}


# str(site_cols)
# mapviewOptions(fgb = F)
m1 <- mapview(site_cols, zcol = 'color', col.regions = site_cols$color,
              legend = F)

mapshot(m1, url = 'figs/lake_color_decade.html')

```


### Why blue, why green?


```{r}
#cart plot examples here:
#http://www.milbo.org/rpart-plot/prp.pdf


set.seed(4444)

train_d <- blue_green_2018 %>%
  sample_frac(0.8)

test_d <- blue_green_2018 %>%
  dplyr::filter(!Hylak_id %in% train_d$Hylak_id) %>%
  dplyr::select(-Hylak_id,-dWL) 

train_d <- train_d %>%
    dplyr::select(-Hylak_id,-dWL) 



## Not run, but code that helped make decision about complexity parameter
# prune_mod <-caret::train(
#   group ~., data = train_d, method = "rpart",
#   trControl = trainControl("boot", number = 100),
#   tuneLength = 100
#   )



cart_mod <- rpart(group ~ ., data = train_d,
                  method = 'class',
                  cp = 0.03) # CP is a tuning knob for tree complexity. 



test_d$guess <- predict(cart_mod, test_d, 'class')
cm <- conf_mat(test_d, group,guess)
accuracy(test_d,group,guess)

png(filename = 'figs/bg_tree.png',
    width = 7, height = 8, units = 'in', res = 300)
rpart.plot(cart_mod,
           # type = 4, #2=split labels below node labels; but I like the look of 4 with labels on both connecting lines and no "yesno"
           extra = 2,#2 = class rate; 106 = prob. of 2nd class + percent of observations
           under = TRUE, #I kind of like the look of this better
           clip.right.labs = FALSE,
           branch = 0.3,
           branch.type = 5, yesno=FALSE, #If you comment out type=4, I kind of like the look of this
           branch.col = "gray",
           main="Factors that influence lake category",
           box.palette = list('#1f78b4','#33a02c'))
# rpart.rules(cart_mod, cover = TRUE)
dev.off()


png(filename = 'figs/bg_confusion_matrix.png',
    width = 6, height = 5,
    units = 'in', res = 300)
autoplot(cm, type = "heatmap") +
  scale_fill_gradient(low="#D6EAF8",high = "#2E86C1")
dev.off()


##Alternative confusion matrix using cvms library, ggplot2 friendly
conf_mat <- confusion_matrix(targets = test_d$group,
                             predictions = test_d$guess)
png(filename = 'figs/bg_confusion_matrix_gg.png',
    width = 6, height = 5,
    units = 'in', res = 300)
plot_confusion_matrix(conf_mat,
                      add_counts = TRUE,
                      add_row_percentages = FALSE,
                      add_col_percentages = FALSE,
                      counts_on_top = TRUE,
                      tile_border_color = 'black',
                      tile_border_linetype = "solid",
                      darkness=0.7)+
  ggplot2::scale_fill_distiller(palette = "Purples",direction=1)+
  labs(x="Truth",
       y="Prediction",
       title="Confusion matrix")
dev.off()
```

Plot some of these relationship for funsies

```{r}
head(blue_green_2018)

blue_green_2018 %>%
ggplot(aes(x=ws_area/area, y=WALA))+
  geom_point()
```